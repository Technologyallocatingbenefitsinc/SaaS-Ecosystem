<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workspace | Editor</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/opendyslexic@2.1.0-beta1/css/opendyslexic.min.css" rel="stylesheet">
    <!-- Tiptap Dependencies (ESM for Browser) -->
    <script type="module">
        import { Editor } from 'https://esm.sh/@tiptap/core';
        import StarterKit from 'https://esm.sh/@tiptap/starter-kit';
        window.Tiptap = { Editor, StarterKit };
    </script>
    <style>
        .ProseMirror {
            outline: none;
            min-height: 500px;
            padding: 1rem;
            color: #334155;
            line-height: 1.6;
        }

        .ProseMirror p.is-editor-empty:first-child::before {
            content: attr(data-placeholder);
            float: left;
            color: #adb5bd;
            pointer-events: none;
            height: 0;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: .5;
            }
        }

        .animate-pulse-slow {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>

<body class="bg-gray-50 text-slate-900 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const DocumentEditor = () => {
            const [editor, setEditor] = useState(null);
            const [isThinking, setIsThinking] = useState(false);
            const editorRef = useRef(null);

            useEffect(() => {
                // Initialize Tiptap when dependencies are ready and component mounts
                const initEditor = async () => {
                    // Small delay to ensure modules load
                    await new Promise(r => setTimeout(r, 500));

                    if (window.Tiptap) {
                        const { Editor, StarterKit } = window.Tiptap;
                        const tipTapEditor = new Editor({
                            element: editorRef.current,
                            extensions: [StarterKit],
                            content: '<p>Start writing or paste your lecture summary here...</p>',
                            autofocus: true,
                        });
                        setEditor(tipTapEditor);
                    }
                };
                initEditor();

                return () => {
                    if (editor) editor.destroy();
                }
            }, []);

            const handleAIRewrite = async () => {
                if (!editor) return;
                setIsThinking(true);
                const text = editor.getText();
                try {
                    const response = await fetch('/editor/rewrite', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: text, tone: 'Professional/Academic' })
                    });
                    const data = await response.json();
                    if (data.rewritten_text) {
                        editor.commands.setContent(data.rewritten_text);
                    }
                } catch (error) {
                    alert("AI Error: " + error);
                } finally {
                    setIsThinking(false);
                }
            };

            const handleExportPDF = async () => {
                if (!editor) return;
                const text = editor.getText(); // For MVP FPDF, we send raw text. HTML->PDF is harder without advanced libs.

                const response = await fetch('/editor/export-pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = "summary.pdf";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                }
            };

            return (
                <div className="flex h-screen">
                    {/* Sidebar Placeholder */}
                    <div className="w-16 bg-slate-900 flex flex-col items-center py-4 gap-4 hidden md:flex">
                        <div className="w-8 h-8 bg-blue-500 rounded-lg"></div>
                        <div className="w-6 h-6 bg-slate-700 rounded-full mt-auto"></div>
                    </div>

                    {/* Main Content */}
                    <main className="flex-1 flex flex-col">
                        {/* Header */}
                        <header className="h-16 border-b bg-white flex items-center justify-between px-6">
                            <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
                                Workspace
                            </h1>
                            <div className="flex gap-2">
                                <button
                                    onClick={handleAIRewrite}
                                    disabled={isThinking}
                                    className={`px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg font-medium hover:bg-indigo-200 transition ${isThinking ? 'animate-pulse-slow' : ''}`}
                                >
                                    {isThinking ? 'Thinking...' : 'âœ¨ AI Polish'}
                                </button>
                                <button
                                    onClick={handleExportPDF}
                                    className="px-4 py-2 bg-slate-900 text-white rounded-lg font-medium hover:bg-slate-800 transition shadow-lg"
                                >
                                    ðŸ“¥ Export PDF
                                </button>
                            </div>
                        </header>

                        {/* Editor Canvas */}
                        <div className="flex-1 bg-gray-50 overflow-auto p-8 flex justify-center">
                            <div className="w-full max-w-4xl bg-white shadow-xl rounded-xl min-h-[800px] border border-gray-100">
                                {/* Editor Toolbar Placeholder */}
                                <div className="border-b p-2 flex gap-2 text-gray-500 text-sm">
                                    <button className="hover:text-black">Bold</button>
                                    <button className="hover:text-black">Italic</button>
                                    <button className="hover:text-black">H1</button>
                                </div>
                                <div ref={editorRef} />
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<DocumentEditor />);
    </script>
</body>

</html>