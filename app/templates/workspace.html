<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workspace | Editor</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- OpenDyslexic Font -->
    <link href="https://cdn.jsdelivr.net/npm/opendyslexic@2.1.0-beta1/css/opendyslexic.min.css" rel="stylesheet">
    <!-- Tiptap Dependencies (ESM for Browser) -->
    <script type="module">
        import { Editor } from 'https://esm.sh/@tiptap/core';
        import StarterKit from 'https://esm.sh/@tiptap/starter-kit';
        import Image from 'https://esm.sh/@tiptap/extension-image';
        window.Tiptap = { Editor, StarterKit, Image };
    </script>
    <style>
        .ProseMirror {
            outline: none;
            min-height: 500px;
            padding: 1rem;
            color: #334155;
            line-height: 1.6;
        }

        .ProseMirror p.is-editor-empty:first-child::before {
            content: attr(data-placeholder);
            float: left;
            color: #adb5bd;
            pointer-events: none;
            height: 0;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: .5;
            }
        }

        .animate-pulse-slow {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .font-dyslexic {
            font-family: 'OpenDyslexic', sans-serif !important;
        }
    </style>
</head>

<body class="bg-gray-50 text-slate-900 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const DocumentEditor = () => {
            const [editor, setEditor] = useState(null);
            const [isThinking, setIsThinking] = useState(false);
            const editorRef = useRef(null);

            useEffect(() => {
                const initEditor = async () => {
                    await new Promise(r => setTimeout(r, 500));
                    if (window.Tiptap) {
                        const { Editor, StarterKit, Image } = window.Tiptap;
                        const tipTapEditor = new Editor({
                            element: editorRef.current,
                            extensions: [StarterKit, Image],
                            content: localStorage.getItem('pendingSummary') || '<p>Start writing or paste your lecture summary here...</p>',
                            autofocus: true,
                        });

                        // Clean up
                        localStorage.removeItem('pendingSummary');

                        setEditor(tipTapEditor);
                    }
                };
                initEditor();
                return () => { if (editor) editor.destroy(); }
            }, []);

            const handleImageUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);

                fetch('/upload/upload-content', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.path) {
                            // Hacky fix: replace "user_uploads" with "/uploads"
                            let webPath = data.path.replace('user_uploads', '/uploads');

                            editor.chain().focus().setImage({ src: webPath }).run();
                        } else {
                            alert("Upload failed");
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert("Error uploading image");
                    });
            };

            const triggerImageInput = () => {
                document.getElementById('editorImageInput').click();
            };

            const handleAIRewrite = async () => {
                if (!editor) return;
                setIsThinking(true);
                const text = editor.getText();
                try {
                    const response = await fetch('/editor/rewrite', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: text, tone: 'Professional/Academic' })
                    });
                    const data = await response.json();
                    if (data.rewritten_text) {
                        editor.commands.setContent(data.rewritten_text);
                    }
                } catch (error) {
                    alert("AI Error: " + error);
                } finally {
                    setIsThinking(false);
                }
            };

            const handleExportPDF = async () => {
                if (!editor) return;
                const text = editor.getText();
                const response = await fetch('/editor/export-pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = "summary.pdf";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                }
            };

            const [isExportModalOpen, setIsExportModalOpen] = useState(false);
            const [selectedTheme, setSelectedTheme] = useState('default');
            const [selectedFormat, setSelectedFormat] = useState('16:9');
            const [selectedFileType, setSelectedFileType] = useState('pptx');
            const [selectedStyle, setSelectedStyle] = useState('neutral');
            const [slideCount, setSlideCount] = useState(10);

            // ... (keep handleAIRewrite, handleExportPDF)

            const openExportModal = () => {
                if (!editor) return;
                setIsExportModalOpen(true);
            };

            const confirmExportPPT = async () => {
                setIsThinking(true);
                const text = editor.getText();
                const endpoint = selectedFileType === 'pdf' ? '/editor/export-slides-pdf' : '/editor/export-pptx';
                const filename = selectedFileType === 'pdf' ? 'study_slides.pdf' : 'study_notes.pptx';

                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: text,
                            html_content: editor.getHTML(), // Send HTML for image parsing
                            theme: selectedTheme,
                            aspect_ratio: selectedFormat,
                            writing_style: selectedStyle,
                            slide_count: slideCount
                        })
                    });
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        setIsExportModalOpen(false);
                    } else {
                        alert("Failed to export. Please try again.");
                    }
                } catch (e) {
                    alert("Export Error: " + e);
                } finally {
                    setIsThinking(false);
                }
            };

            const styles = [
                { id: 'neutral', name: 'Neutral', icon: 'üòê' },
                { id: 'professional', name: 'Professional', icon: 'üëî' },
                { id: 'fun', name: 'Fun/Engaging', icon: 'üéâ' },
                { id: 'academic', name: 'Academic', icon: 'üéì' }
            ];

            const themes = [
                { id: 'default', name: 'Clean White', color: 'bg-white border-gray-200' },
                { id: 'dark', name: 'Dark Mode', color: 'bg-slate-900 border-slate-700 text-white' },
                { id: 'corporate', name: 'Corporate', color: 'bg-blue-50 border-blue-200' },
                { id: 'warm', name: 'Warm', color: 'bg-orange-50 border-orange-200' },
                { id: 'sunset', name: 'Sunset', color: 'bg-rose-50 border-rose-200' },
                { id: 'forest', name: 'Forest', color: 'bg-green-50 border-green-200' },
                { id: 'ocean', name: 'Ocean', color: 'bg-cyan-50 border-cyan-200' },
                { id: 'luxury', name: 'Luxury', color: 'bg-slate-900 border-yellow-500 text-yellow-500' }
            ];

            return (
                <div className="flex h-screen">
                    {/* Sidebar */}
                    <div className="w-16 bg-slate-900 flex flex-col items-center py-4 gap-4 hidden md:flex">
                        <img src="/static/images/modyfire_logo.jpg" alt="Logo" className="w-10 h-10 rounded-lg object-cover" />
                        <div className="w-6 h-6 bg-slate-700 rounded-full mt-auto"></div>
                    </div>

                    <main className="flex-1 flex flex-col relative h-full">
                        <header className="h-16 border-b bg-white flex items-center justify-between px-6">
                            <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
                                Workspace
                            </h1>
                            <div className="flex gap-2">
                                <button
                                    onClick={handleAIRewrite}
                                    disabled={isThinking}
                                    className={`px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg font-medium hover:bg-indigo-200 transition ${isThinking ? 'animate-pulse-slow' : ''}`}
                                >
                                    {isThinking ? 'Thinking...' : '‚ú® AI Polish'}
                                </button>
                                <input
                                    type="file"
                                    id="editorImageInput"
                                    className="hidden"
                                    accept="image/*"
                                    onChange={handleImageUpload}
                                />
                                <button
                                    onClick={triggerImageInput}
                                    className="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg font-medium hover:bg-slate-200 transition"
                                >
                                    üì∑ Add Media
                                </button>
                                <button
                                    onClick={() => document.body.classList.toggle('font-dyslexic')}
                                    className="px-3 py-2 bg-white border border-gray-200 text-slate-600 rounded-lg hover:bg-gray-50 font-bold"
                                    title="Toggle Dyslexic Font"
                                >
                                    Aa
                                </button>
                                <button
                                    onClick={handleExportPDF}
                                    className="px-4 py-2 bg-slate-900 text-white rounded-lg font-medium hover:bg-slate-800 transition shadow-lg"
                                >
                                    üì• Export PDF
                                </button>
                                <button
                                    onClick={openExportModal}
                                    className="px-4 py-2 bg-orange-600 text-white rounded-lg font-medium hover:bg-orange-700 transition shadow-lg flex items-center gap-2"
                                >
                                    <span>üìä</span> Export PPT
                                </button>
                            </div>
                        </header>

                        <div className="flex-1 bg-gray-50 overflow-auto p-8 flex justify-center">
                            <div className="w-full max-w-4xl bg-white shadow-xl rounded-xl min-h-[800px] h-fit border border-gray-100 mb-20">
                                <div className="border-b p-2 flex gap-2 text-gray-500 text-sm">
                                    <button className="hover:text-black">Bold</button>
                                    <button className="hover:text-black">Italic</button>
                                    <button className="hover:text-black">H1</button>
                                </div>
                                <div ref={editorRef} />
                            </div>
                        </div>

                        {isExportModalOpen && (
                            <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[85vh] overflow-y-auto animate-fade-in-up flex flex-col">
                                    <div className="p-6 border-b border-gray-100 flex-shrink-0 bg-white sticky top-0 z-10">
                                        <h3 className="text-xl font-bold text-slate-900">Export Presentation</h3>
                                        <p className="text-sm text-slate-500 mt-1">Select format and style.</p>
                                    </div>

                                    <div className="p-6 space-y-6">
                                        {/* File Type Selection */}
                                        <div>
                                            <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">File Type</label>
                                            <div className="flex bg-gray-100 p-1 rounded-lg">
                                                <button
                                                    onClick={() => setSelectedFileType('pptx')}
                                                    className={`flex-1 py-2 text-sm font-bold rounded-md transition ${selectedFileType === 'pptx' ? 'bg-white shadow text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}
                                                >
                                                    PowerPoint (.pptx)
                                                </button>
                                                <button
                                                    onClick={() => setSelectedFileType('pdf')}
                                                    className={`flex-1 py-2 text-sm font-bold rounded-md transition ${selectedFileType === 'pdf' ? 'bg-white shadow text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}
                                                >
                                                    PDF Presentation (.pdf)
                                                </button>
                                            </div>
                                        </div>

                                        {/* Style Selection */}
                                        <div>
                                            <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">AI Writing Style</label>
                                            <div className="grid grid-cols-4 gap-2">
                                                {styles.map(style => (
                                                    <button
                                                        key={style.id}
                                                        onClick={() => setSelectedStyle(style.id)}
                                                        className={`p-2 rounded-lg border text-center transition ${selectedStyle === style.id ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-gray-200 hover:bg-gray-50'}`}
                                                    >
                                                        <div className="text-xl mb-1">{style.icon}</div>
                                                        <div className="text-[10px] font-bold">{style.name}</div>
                                                    </button>
                                                ))}
                                            </div>
                                        </div>

                                        {/* Slide Count Selection */}
                                        <div>
                                            <div className="flex justify-between items-center mb-2">
                                                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider block">Slide Count</label>
                                                <span className="text-sm font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-md">{slideCount} Slides</span>
                                            </div>
                                            <input
                                                type="range"
                                                min="1"
                                                max="20"
                                                value={slideCount}
                                                onChange={(e) => setSlideCount(parseInt(e.target.value))}
                                                className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                                            />
                                            <div className="flex justify-between text-[10px] text-gray-400 mt-1">
                                                <span>1</span>
                                                <span>10</span>
                                                <span>20</span>
                                            </div>
                                        </div>

                                        {/* Format Selection */}
                                        <div>
                                            <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">Format</label>
                                            <div className="grid grid-cols-2 gap-3">
                                                <button
                                                    onClick={() => setSelectedFormat('16:9')}
                                                    className={`p-3 rounded-lg border-2 flex flex-col items-center gap-2 transition ${selectedFormat === '16:9' ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-gray-200 hover:border-blue-200 text-slate-600'}`}
                                                >
                                                    <div className="w-12 h-8 border-2 border-current rounded-sm"></div>
                                                    <span className="text-xs font-bold">Standard (16:9)</span>
                                                </button>
                                                <button
                                                    onClick={() => setSelectedFormat('1:1')}
                                                    className={`p-3 rounded-lg border-2 flex flex-col items-center gap-2 transition ${selectedFormat === '1:1' ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-gray-200 hover:border-blue-200 text-slate-600'}`}
                                                >
                                                    <div className="w-8 h-8 border-2 border-current rounded-sm"></div>
                                                    <span className="text-xs font-bold">Carousel (1:1)</span>
                                                </button>
                                            </div>
                                        </div>

                                        {/* Theme Selection */}
                                        <div>
                                            <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">Theme</label>
                                            <div className="grid grid-cols-2 gap-3">
                                                {themes.map(theme => (
                                                    <button
                                                        key={theme.id}
                                                        onClick={() => setSelectedTheme(theme.id)}
                                                        className={`p-3 rounded-lg border-2 text-left transition relative ${theme.color} ${selectedTheme === theme.id ? 'ring-2 ring-blue-500 ring-offset-2 border-transparent' : 'border-gray-200 hover:border-blue-300'}`}
                                                    >
                                                        <div className="font-bold text-sm">{theme.name}</div>
                                                        {selectedTheme === theme.id && <div className="absolute top-2 right-2 text-blue-500"><i className="fas fa-check-circle text-xs"></i></div>}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>

                                    <div className="p-6 bg-gray-50 flex justify-end gap-3 border-t border-gray-100">
                                        <button
                                            onClick={() => setIsExportModalOpen(false)}
                                            className="px-4 py-2 text-slate-600 font-bold hover:bg-gray-200 rounded-lg transition"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onClick={confirmExportPPT}
                                            disabled={isThinking}
                                            className="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition shadow-lg flex items-center gap-2"
                                        >
                                            {isThinking ? 'Generating...' : 'Download PPTX'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<DocumentEditor />);
    </script>
</body>

</html>