<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workspace | Editor</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { theme: { extend: {} } }</script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- OpenDyslexic Font -->
    <link href="https://cdn.jsdelivr.net/npm/opendyslexic@2.1.0-beta1/css/opendyslexic.min.css" rel="stylesheet">
    <!-- Tiptap Dependencies (ESM for Browser) -->
    <!-- Tiptap: Loaded globally to avoid Babel/ESM conflict -->
    <script type="module">
        import { Editor } from 'https://esm.sh/@tiptap/core';
        import StarterKit from 'https://esm.sh/@tiptap/starter-kit';
        import Image from 'https://esm.sh/@tiptap/extension-image';

        window.TiptapEditor = Editor;
        window.TiptapStarterKit = StarterKit;
        window.TiptapImage = Image;
    </script>
    <style>
        .ProseMirror {
            outline: none;
            min-height: 500px;
            padding: 1rem;
            color: #334155;
            line-height: 1.6;
        }

        .ProseMirror p.is-editor-empty:first-child::before {
            content: attr(data-placeholder);
            float: left;
            color: #adb5bd;
            pointer-events: none;
            height: 0;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: .5;
            }
        }

        .animate-pulse-slow {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .font-dyslexic {
            font-family: 'OpenDyslexic', sans-serif !important;
        }

        /* Flashcard Flip Animation */
        .perspective-1000 {
            perspective: 1000px;
        }

        .transform-style-3d {
            transform-style: preserve-3d;
        }

        .backface-hidden {
            backface-visibility: hidden;
        }

        .rotate-y-180 {
            transform: rotateY(180deg);
        }

        /* Accessibility: Focus Styles */
        :focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        :focus:not(:focus-visible) {
            outline: none;
        }
    </style>
</head>

<body class="bg-gray-50 text-slate-900 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const USER_TIER = "{{ tier }}";

        const useFocusTrap = (isOpen, modalRef) => {
            useEffect(() => {
                if (!isOpen || !modalRef.current) return;

                const focusableElements = modalRef.current.querySelectorAll(
                    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                );
                const firstElement = focusableElements[0];
                const lastElement = focusableElements[focusableElements.length - 1];

                const handleTab = (e) => {
                    if (e.key !== 'Tab') return;

                    if (e.shiftKey) {
                        if (document.activeElement === firstElement) {
                            e.preventDefault();
                            lastElement.focus();
                        }
                    } else {
                        if (document.activeElement === lastElement) {
                            e.preventDefault();
                            firstElement.focus();
                        }
                    }
                };

                firstElement?.focus();
                document.addEventListener('keydown', handleTab);
                return () => document.removeEventListener('keydown', handleTab);
            }, [isOpen]);
        };

        const Whiteboard = () => {
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);
            const [tool, setTool] = useState('brush'); // 'brush', 'eraser'
            const [color, setColor] = useState('#3b82f6');

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                ctx.lineCap = 'round';
                ctx.lineWidth = 3;
            }, []);

            const startDrawing = (e) => {
                const canvas = canvasRef.current;
                const rect = canvas.getBoundingClientRect();
                const ctx = canvas.getContext('2d');
                ctx.beginPath();
                ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
                setIsDrawing(true);
            };

            const draw = (e) => {
                if (!isDrawing) return;
                const canvas = canvasRef.current;
                const rect = canvas.getBoundingClientRect();
                const ctx = canvas.getContext('2d');
                ctx.strokeStyle = tool === 'eraser' ? '#ffffff' : color;
                ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
                ctx.stroke();
            };

            const stopDrawing = () => setIsDrawing(false);

            const clearCanvas = () => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            };

            return (
                <div className="flex flex-col h-full bg-white w-full">
                    <div className="p-3 border-b flex gap-6 items-center bg-gray-50">
                        <div className="flex bg-white rounded-lg p-1 border border-gray-200">
                            <button
                                onClick={() => setTool('brush')}
                                className={`px-4 py-1.5 text-xs font-bold rounded-md transition ${tool === 'brush' ? 'bg-blue-600 text-white shadow-md' : 'text-slate-600 hover:bg-gray-100'}`}
                            >
                                <i className="fas fa-paint-brush mr-2"></i>Brush
                            </button>
                            <button
                                onClick={() => setTool('eraser')}
                                className={`px-4 py-1.5 text-xs font-bold rounded-md transition ${tool === 'eraser' ? 'bg-blue-600 text-white shadow-md' : 'text-slate-600 hover:bg-gray-100'}`}
                            >
                                <i className="fas fa-eraser mr-2"></i>Eraser
                            </button>
                        </div>
                        <div className="flex items-center gap-3">
                            <label className="text-[10px] font-black uppercase text-slate-400">Color</label>
                            <input type="color" value={color} onChange={(e) => setColor(e.target.value)} className="w-8 h-8 rounded-full cursor-pointer border-2 border-white shadow-sm overflow-hidden p-0" />
                        </div>
                        <button onClick={clearCanvas} className="ml-auto text-xs font-black uppercase text-red-500 hover:text-red-700 tracking-wider">
                            <i className="fas fa-trash-alt mr-2"></i>Clear Board
                        </button>
                    </div>
                    <canvas
                        ref={canvasRef}
                        width={1400}
                        height={1000}
                        onMouseDown={startDrawing}
                        onMouseMove={draw}
                        onMouseUp={stopDrawing}
                        onMouseOut={stopDrawing}
                        className="flex-1 cursor-crosshair touch-none bg-white"
                    />
                </div>
            );
        };

        const DocumentEditor = () => {
            const [editor, setEditor] = useState(null);
            const [isThinking, setIsThinking] = useState(false); // AI Rewrite
            const [isGenerating, setIsGenerating] = useState(false); // Export/Preview
            const [saveStatus, setSaveStatus] = useState('saved'); // 'saved', 'saving', 'unsaved'

            const [isExportModalOpen, setIsExportModalOpen] = useState(false); // Export Modal

            // Study Tools State
            const [isQuizModalOpen, setIsQuizModalOpen] = useState(false);
            const [isFlashcardModalOpen, setIsFlashcardModalOpen] = useState(false);
            const [isStudyLoading, setIsStudyLoading] = useState(false);
            const [quizData, setQuizData] = useState([]);
            const [flashcardData, setFlashcardData] = useState([]);
            const [currentCardIndex, setCurrentCardIndex] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);
            const [quizAnswers, setQuizAnswers] = useState({}); // { questionIndex: selectedOption }
            const [quizScore, setQuizScore] = useState(null);
            // Social Clips State
            const [isClipsModalOpen, setIsClipsModalOpen] = useState(false);
            const [clipsData, setClipsData] = useState([]);
            const [clipsUrl, setClipsUrl] = useState(''); // User inputs URL here for analysis

            // Audio Overview State
            const [isAudioModalOpen, setIsAudioModalOpen] = useState(false);
            const [audioScript, setAudioScript] = useState([]);
            const [audioUrl, setAudioUrl] = useState(null);
            const [isAudioLoading, setIsAudioLoading] = useState(false);
            const [isCarouselModalOpen, setIsCarouselModalOpen] = useState(false);
            const [carouselData, setCarouselData] = useState("");
            const [activeTab, setActiveTab] = useState('editor'); // 'editor', 'whiteboard'

            // Chat Assistant State
            const [isChatOpen, setIsChatOpen] = useState(false);
            const [chatHistory, setChatHistory] = useState([{ role: 'assistant', text: "Hi! I've watched the video. Ask me anything!" }]);
            const [chatInput, setChatInput] = useState('');
            const [isChatLoading, setIsChatLoading] = useState(false);

            const handleChatSubmit = async (e) => {
                e.preventDefault();
                if (!chatInput.trim()) return;

                const userMsg = chatInput;
                setChatInput('');
                setChatHistory(prev => [...prev, { role: 'user', text: userMsg }]);
                setIsChatLoading(true);

                try {
                    const response = await fetch('/editor/chat-video', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: userMsg, context: editor ? editor.getText() : "" })
                    });
                    const data = await response.json();
                    setChatHistory(prev => [...prev, { role: 'assistant', text: data.response || "I didn't get a response." }]);
                } catch (err) {
                    console.error(err);
                    setChatHistory(prev => [...prev, { role: 'assistant', text: "Sorry, I'm having trouble connecting right now." }]);
                } finally {
                    setIsChatLoading(false);
                }
            };

            // Add other states that might be missing from view if needed, or rely on defaults if they are defined further down? 
            // Warning: if I redefine vars that are defined below, it errors. 
            // But looking at previous view, only editor/isThinking were defined at top.
            // I'll define these here.

            const [selectedFileType, setSelectedFileType] = useState('pptx');
            const [selectedStyle, setSelectedStyle] = useState('neutral');
            const [slideCount, setSlideCount] = useState(10);
            const [selectedFormat, setSelectedFormat] = useState('16:9');
            const [selectedTheme, setSelectedTheme] = useState('default');
            const [selectedLanguage, setSelectedLanguage] = useState('English');

            const editorRef = useRef(null);
            const saveTimeoutRef = useRef(null);
            const exportModalRef = useRef(null);
            const quizModalRef = useRef(null);
            const clipsModalRef = useRef(null);
            const audioModalRef = useRef(null);
            const carouselModalRef = useRef(null);
            const flashcardModalRef = useRef(null);

            useFocusTrap(isExportModalOpen, exportModalRef);
            useFocusTrap(isQuizModalOpen, quizModalRef);
            useFocusTrap(isClipsModalOpen, clipsModalRef);
            useFocusTrap(isAudioModalOpen, audioModalRef);
            useFocusTrap(isCarouselModalOpen, carouselModalRef);
            useFocusTrap(isFlashcardModalOpen, flashcardModalRef);

            const [currentDeckId, setCurrentDeckId] = useState(null);

            // Debounced Save
            const triggerSave = (content) => {
                setSaveStatus('saving');
                if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);

                saveTimeoutRef.current = setTimeout(async () => {
                    // 1. Local Auto-Save (always backup)
                    localStorage.setItem('workspace_autosave', content);

                    // 2. Cloud Save (if we have an ID)
                    if (currentDeckId) {
                        try {
                            const res = await fetch(`/api/deck/${currentDeckId}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ content: content })
                            });
                            if (!res.ok) throw new Error("Cloud save failed");
                        } catch (e) {
                            console.error("Cloud Save Error:", e);
                            // Maybe set status to 'unsaved' or 'error'?
                            setSaveStatus('error');
                            return;
                        }
                    }

                    setSaveStatus('saved');
                }, 1000);
            };

            useEffect(() => {
                const initEditor = async () => {
                    try {
                        // Check URL for Deck ID
                        const urlParams = new URLSearchParams(window.location.search);
                        const deckId = urlParams.get('id');
                        let remoteContent = null;

                        if (deckId) {
                            setCurrentDeckId(deckId);
                            // Fetch fresh content
                            try {
                                const res = await fetch(`/api/deck/${deckId}`);
                                if (res.ok) {
                                    const data = await res.json();
                                    remoteContent = data.content;
                                }
                            } catch (e) {
                                console.error("Failed to fetch deck:", e);
                            }
                        }

                        // Load modules globally to avoid Babel conflict
                        const Editor = window.TiptapEditor;
                        const StarterKit = window.TiptapStarterKit;
                        const Image = window.TiptapImage;

                        if (!Editor || !StarterKit) {
                            throw new Error("Modules loaded but exports were missing.");
                        }

                        // Load Content Priority: Remote (Fresh) -> Pending (New) -> Autosave (Old) -> Default
                        const saved = localStorage.getItem('workspace_autosave');
                        const pending = localStorage.getItem('pendingSummary');

                        // If we pulled remote content, use it. Otherwise fall back.
                        const content = remoteContent || pending || saved || '<p>Start writing or paste your lecture summary here...</p>';

                        const tipTapEditor = new Editor({
                            element: editorRef.current,
                            extensions: [StarterKit, Image],
                            content: content,
                            autofocus: true,
                            onUpdate: ({ editor }) => {
                                triggerSave(editor.getHTML());
                            }
                        });

                        if (pending) {
                            localStorage.removeItem('pendingSummary');
                            // We don't remove autosave yet, nice to have backup
                        }

                        setEditor(tipTapEditor);
                    } catch (error) {
                        console.error("Tiptap Loading Error:", error);
                        if (editorRef.current) {
                            editorRef.current.innerHTML = `<p class='text-red-500 font-bold'>Error: Failed to load editor resources (${error.message}). Please check your internet connection or try disabling ad-blockers.</p>`;
                        }
                    }
                };
                initEditor();

                // Cleanup: Access editor from state won't work in closure with [] dep, 
                // but Tiptap cleans up its own DOM element mostly.
                // To fix properly, we'd need to store editor instance in a ref or use setEditor callback logic.
                // For now, this prevents the syntax error.
                return () => {
                    // no-op to avoid closure issues
                };
            }, []);

            // Keyboard Shortcuts
            useEffect(() => {
                const handleKeyDown = (e) => {
                    // Cmd + S or Ctrl + S => Force Save
                    if ((e.metaKey || e.ctrlKey) && e.key === 's') {
                        e.preventDefault();
                        if (editor) {
                            // Immediate save logic or reuse triggerSave (which is debounced)
                            // Let's force immediately if user explicitly presses save? 
                            // Or just trigger the existing debounce is fine.
                            triggerSave(editor.getHTML());

                            // Visual toggle to show acknowledgment
                            setSaveStatus('saving');
                        }
                    }
                };

                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [editor, currentDeckId]); // Re-bind if editor or ID changes

            const handleImageUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);

                fetch('/upload/upload-content', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if (!response.ok) throw new Error("Server error: " + response.status);
                        return response.json();
                    })
                    .then(data => {
                        if (data.url) {
                            const webPath = data.url;
                            editor.chain().focus().setImage({ src: webPath }).run();
                        } else {
                            alert("Upload failed: No URL returned. " + (data.message || ''));
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert("Error uploading image: " + err.message);
                    });
            };

            const triggerImageInput = () => {
                document.getElementById('editorImageInput').click();
            };

            const handleAIRewrite = async () => {
                if (!editor) return;
                setIsThinking(true);
                const text = editor.getText();
                try {
                    const response = await fetch('/editor/rewrite', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: text, tone: 'Professional/Academic' })
                    });
                    const data = await response.json();
                    if (data.rewritten_text) {
                        editor.commands.setContent(data.rewritten_text);
                    }
                } catch (error) {
                    alert("AI Error: " + error);
                } finally {
                    setIsThinking(false);
                }
            };

            const handleExportPDF = async () => {
                if (!editor) return;
                const text = editor.getText();
                const response = await fetch('/editor/export-pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = "summary.pdf";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                }
            };


            // ... (keep handleAIRewrite, handleExportPDF)



            const generateStudyTool = async (type) => {
                if (!editor) return;
                const text = editor.getText();
                if (!text.trim()) return alert("Please add some notes first!");

                setIsStudyLoading(true);

                try {
                    let endpoint = '/editor/generate-flashcards';
                    if (type === 'quiz') endpoint = '/editor/generate-quiz';
                    else if (type === 'blog') endpoint = '/editor/generate-blog';
                    else if (type === 'carousel') endpoint = '/editor/generate-carousel';

                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: text, language: selectedLanguage })
                    });

                    const data = await response.json();

                    if (type === 'quiz') {
                        if (data.questions) {
                            setQuizData(data.questions);
                            setQuizAnswers({});
                            setQuizScore(null);
                            setIsQuizModalOpen(true);
                        } else {
                            alert("Failed to generate quiz.");
                        }
                    } else if (type === 'flashcards') {
                        if (data.flashcards) {
                            setFlashcardData(data.flashcards);
                            setCurrentCardIndex(0);
                            setIsFlipped(false);
                            setIsFlashcardModalOpen(true);
                        } else {
                            alert("Failed to generate flashcards.");
                        }
                    } else if (type === 'blog') {
                        if (data.blog) {
                            // Prepend blog to editor or replace? User usually wants it as a draft.
                            editor.commands.setContent(`<h1>Blog Post</h1>` + data.blog);
                        } else {
                            alert("Failed to generate blog post.");
                        }
                    } else if (type === 'carousel') {
                        if (data.carousel) {
                            // Open carousel modal
                            setCarouselData(data.carousel);
                            setIsCarouselModalOpen(true);
                        } else {
                            alert("Failed to generate carousel script.");
                        }
                    }

                } catch (e) {
                    alert("Error: " + e);
                } finally {
                    setIsStudyLoading(false);
                }
            };

            const submitQuiz = () => {
                let score = 0;
                quizData.forEach((q, idx) => {
                    if (quizAnswers[idx] === q.answer) score++;
                });
                setQuizScore(score);
            };

            const openExportModal = () => {
                if (!editor) return;
                setIsExportModalOpen(true);
            };

            const handlePreviewPDF = async () => {
                setIsGenerating(true);
                try {
                    const text = editor.getText();
                    if (!text.trim()) {
                        alert("Please enter some text first");
                        setIsGenerating(false);
                        return;
                    }

                    const response = await fetch('/editor/preview-pdf', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: text,
                            html_content: editor.getHTML(),
                            theme: selectedTheme,
                            aspect_ratio: selectedFormat,
                            writing_style: selectedStyle,
                            slide_count: slideCount,
                            language: selectedLanguage
                        })
                    });

                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        window.open(url, '_blank'); // Open PDF in new tab
                        setTimeout(() => window.URL.revokeObjectURL(url), 100);
                        setIsExportModalOpen(false);
                    } else {
                        // Extract detailed error message
                        const errorData = await response.json();
                        alert("Preview failed: " + (errorData.detail || "Unknown error"));
                    }
                } catch (error) {
                    console.error('Preview error:', error);
                    alert("An error occurred during preview generation.");
                } finally {
                    setIsGenerating(false);
                }
            };

            const confirmExportPPT = async (type = 'pptx') => {
                setIsGenerating(true);
                try {
                    const text = editor.getText();
                    const endpoint = type === 'pdf' ? '/editor/export-slides-pdf' : '/editor/export-pptx';
                    const filename = type === 'pdf' ? 'study_slides.pdf' : 'study_notes.pptx';

                    // Reduced timeouts / clearer error handling could go here
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: text,
                            html_content: editor.getHTML(),
                            theme: selectedTheme,
                            aspect_ratio: selectedFormat,
                            writing_style: selectedStyle,
                            slide_count: slideCount,
                            language: selectedLanguage
                        })
                    });

                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        window.URL.revokeObjectURL(url);
                        if (type === 'pptx') setIsExportModalOpen(false); // Only close on PPTX, maybe keep open for PDF?
                        else setIsExportModalOpen(false);
                    } else {
                        const errorData = await response.json();
                        alert("Export failed: " + (errorData.detail || "Unknown error"));
                    }
                } catch (e) {
                    console.error(e);
                    alert("An error occurred during export. Please try again.");
                } finally {
                    setIsGenerating(false);
                }
            };

            const handleGenerateAudioScript = async () => {
                if (!editor) return;
                const text = editor.getText();
                if (!text.trim()) return alert("Please add some notes first!");

                setIsAudioLoading(true);
                try {
                    const response = await fetch('/editor/generate-audio-script', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: text, language: selectedLanguage })
                    });
                    const data = await response.json();
                    if (data.script) {
                        setAudioScript(data.script);
                    } else {
                        alert("Failed to generate script: " + (data.detail || "Unknown error"));
                    }
                } catch (e) {
                    alert("Error: " + e);
                } finally {
                    setIsAudioLoading(false);
                }
            };

            const handleSynthesizeAudio = async () => {
                if (audioScript.length === 0) return;
                setIsAudioLoading(true);
                try {
                    const response = await fetch('/editor/synthesize-audio', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ script: audioScript })
                    });
                    const data = await response.json();
                    if (data.audio_url) {
                        setAudioUrl(data.audio_url);
                    } else {
                        alert("Audio generation failed");
                    }
                } catch (e) {
                    alert("Error: " + e);
                } finally {
                    setIsAudioLoading(false);
                }
            };

            const styles = [
                { id: 'neutral', name: 'Neutral', icon: 'üòê' },
                { id: 'professional', name: 'Professional', icon: 'üëî' },
                { id: 'fun', name: 'Fun/Engaging', icon: 'üéâ' },
                { id: 'academic', name: 'Academic', icon: 'üéì' }
            ];

            const languages = [
                { code: 'English', label: 'üá∫üá∏ English' },
                { code: 'Spanish', label: 'üá™üá∏ Spanish' },
                { code: 'French', label: 'üá´üá∑ French' },
                { code: 'German', label: 'üá©üá™ German' },
                { code: 'Hindi', label: 'üáÆüá≥ Hindi' },
                { code: 'Mandarin', label: 'üá®üá≥ Mandarin' },
                { code: 'Portuguese', label: 'üáßüá∑ Portuguese' },
                { code: 'Italian', label: 'üáÆüáπ Italian' },
                { code: 'Arabic', label: 'üá∏üá¶ Arabic' },
                { code: 'Russian', label: 'üá∑üá∫ Russian' },
                { code: 'Japanese', label: 'üáØüáµ Japanese' },
                { code: 'Korean', label: 'üá∞üá∑ Korean' }
            ];

            const themes = [
                { id: 'default', name: 'Clean White', color: 'bg-white border-gray-200' },
                { id: 'dark', name: 'Dark Mode', color: 'bg-slate-900 border-slate-700 text-white' },
                { id: 'corporate', name: 'Corporate', color: 'bg-blue-50 border-blue-200' },
                { id: 'warm', name: 'Warm', color: 'bg-orange-50 border-orange-200' },
                { id: 'sunset', name: 'Sunset', color: 'bg-rose-50 border-rose-200' },
                { id: 'forest', name: 'Forest', color: 'bg-green-50 border-green-200' },
                { id: 'ocean', name: 'Ocean', color: 'bg-cyan-50 border-cyan-200' },
                { id: 'luxury', name: 'Luxury', color: 'bg-slate-900 border-yellow-500 text-yellow-500' }
            ];

            // Dark Mode Effect
            useEffect(() => {
                if (localStorage.getItem('theme') === 'dark' ||
                    (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, []);

            const toggleDarkMode = () => {
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                }
            };

            // History State
            const [isLibraryOpen, setIsLibraryOpen] = useState(false);
            const [deckHistory, setDeckHistory] = useState([]);

            useEffect(() => {
                const fetchHistory = async () => {
                    try {
                        const res = await fetch('/api/decks');
                        if (res.ok) {
                            const data = await res.json();
                            setDeckHistory(data);
                        }
                    } catch (e) {
                        console.error("Failed to fetch history", e);
                    }
                };
                if (isLibraryOpen) fetchHistory();
            }, [isLibraryOpen]);

            return (
                <div className="flex h-screen">
                    {/* Skip to Main Content Link */}
                    <a href="#mainContent" className="sr-only focus:not-sr-only focus:fixed focus:top-4 focus:left-4 focus:z-[100] focus:bg-blue-600 focus:text-white focus:px-4 focus:py-2 focus:rounded-lg focus:font-bold">
                        Skip to main content
                    </a>

                    {/* Sidebar */}
                    <div className="w-16 bg-slate-900 flex flex-col items-center py-4 gap-4 hidden md:flex z-50 relative">
                        <img src="/static/images/modyfire_logo.jpg" alt="Logo" className="w-10 h-10 rounded-lg object-cover" />

                        <button onClick={() => setIsLibraryOpen(!isLibraryOpen)} className={`p-2 transition ${isLibraryOpen ? 'text-white' : 'text-slate-400 hover:text-white'}`} title="My Library">
                            <i className="fas fa-folder-open"></i>
                        </button>

                        <button onClick={toggleDarkMode} className="p-2 text-slate-400 hover:text-white transition mt-auto" title="Toggle Dark Mode">
                            <i className="fas fa-moon"></i>
                        </button>
                    </div>

                    {/* Library Drawer */}
                    <div className={`fixed inset-y-0 left-16 w-64 bg-white dark:bg-slate-800 shadow-2xl transform transition-transform duration-300 z-40 border-r border-gray-200 dark:border-slate-700 ${isLibraryOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-4 border-b border-gray-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900">
                            <h3 className="font-bold text-slate-800 dark:text-white">My Library</h3>
                            <button onClick={() => setIsLibraryOpen(false)} className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i className="fas fa-times"></i></button>
                        </div>
                        <div className="overflow-y-auto h-full p-2 space-y-1">
                            {deckHistory.map(deck => (
                                <a key={deck.id} href={`/workspace?id=${deck.id}`} className="block p-3 rounded-lg hover:bg-blue-50 dark:hover:bg-slate-700 group border border-transparent hover:border-blue-100 dark:hover:border-slate-600 transition">
                                    <div className="text-sm font-bold text-slate-700 dark:text-slate-200 truncate">{deck.title || "Untitled Deck"}</div>
                                    <div className="text-xs text-slate-400">{deck.date}</div>
                                </a>
                            ))}
                            {deckHistory.length === 0 && <div className="p-4 text-center text-sm text-slate-400">No history yet.</div>}
                        </div>
                    </div>

                    <main id="mainContent" className="flex-1 flex flex-col relative h-full">
                        <header className="h-16 border-b bg-white flex items-center justify-between px-6">
                            <div className="flex items-center gap-4">
                                <a href="/dashboard" className="p-2 mr-2 text-slate-500 hover:text-slate-700 hover:bg-slate-100 rounded-full transition" title="Back to Dashboard">
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                                    </svg>
                                </a>
                                <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
                                    Workspace
                                </h1>
                            </div>
                            <div className="flex gap-2">
                                <div className="relative group z-50">
                                    <button className="px-3 py-2 bg-slate-100 text-slate-700 rounded-lg font-medium hover:bg-slate-200 transition text-sm flex items-center gap-1">
                                        {languages.find(l => l.code === selectedLanguage)?.label?.split(' ')[0] || 'üá∫üá∏'} ‚ñº
                                    </button>
                                    <div className="absolute right-0 mt-2 w-40 bg-white rounded-xl shadow-xl border border-gray-100 hidden group-hover:block max-h-60 overflow-y-auto">
                                        {languages.map(lang => (
                                            <button
                                                key={lang.code}
                                                onClick={() => setSelectedLanguage(lang.code)}
                                                className={`w-full text-left px-4 py-2 hover:bg-gray-50 text-sm ${selectedLanguage === lang.code ? 'bg-blue-50 text-blue-600 font-bold' : 'text-slate-700'}`}
                                            >
                                                {lang.label}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <button
                                    onClick={handleAIRewrite}
                                    disabled={isThinking}
                                    className={`px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg font-medium hover:bg-indigo-200 transition ${isThinking ? 'animate-pulse-slow' : ''}`}
                                >
                                    {isThinking ? 'Thinking...' : '‚ú® AI Polish'}
                                </button>
                                <input
                                    type="file"
                                    id="editorImageInput"
                                    className="hidden"
                                    accept="image/*"
                                    onChange={handleImageUpload}
                                />
                                <button
                                    onClick={triggerImageInput}
                                    className="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg font-medium hover:bg-slate-200 transition"
                                >
                                    üì∑ Add Media
                                </button>

                                {/* Tools Dropdown */}
                                <div className="relative group">
                                    <button className="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg font-medium hover:bg-purple-200 transition flex items-center gap-2">
                                        {USER_TIER === 'podcaster' ? 'üöÄ Growth Tools' : 'üß† Study Tools'}
                                    </button>
                                    <div className="absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-xl border border-gray-100 hidden group-hover:block z-50">
                                        {(USER_TIER === 'student' || USER_TIER === 'professor' || USER_TIER === 'pro') && (
                                            <>
                                                <button
                                                    onClick={() => generateStudyTool('quiz')}
                                                    className="w-full text-left px-4 py-3 hover:bg-gray-50 rounded-t-xl text-sm font-bold text-slate-700 block"
                                                >
                                                    üìù Generate Quiz
                                                </button>
                                                <button
                                                    onClick={() => generateStudyTool('flashcards')}
                                                    className="w-full text-left px-4 py-3 hover:bg-gray-50 text-sm font-bold text-slate-700 block"
                                                >
                                                    üìá Generate Flashcards
                                                </button>
                                            </>
                                        )}

                                        {(USER_TIER === 'pro' || USER_TIER === 'podcaster') && (
                                            <>
                                                <div className="border-t border-gray-100"></div>
                                                <button
                                                    onClick={() => setIsClipsModalOpen(true)}
                                                    className="w-full text-left px-4 py-3 hover:bg-pink-50 text-sm font-bold text-pink-600 block flex items-center gap-2"
                                                >
                                                    üé¨ Instagram/LinkedIn Clips
                                                </button>
                                                <button
                                                    onClick={() => generateStudyTool('carousel')}
                                                    className="w-full text-left px-4 py-3 hover:bg-blue-50 text-sm font-bold text-blue-600 block flex items-center gap-2"
                                                >
                                                    üé° LinkedIn Carousel Script
                                                </button>
                                                <button
                                                    onClick={() => generateStudyTool('blog')}
                                                    className="w-full text-left px-4 py-3 hover:bg-orange-50 text-sm font-bold text-orange-600 block flex items-center gap-2"
                                                >
                                                    ‚úçÔ∏è Video to Blog Post
                                                </button>
                                                <button
                                                    onClick={() => setIsAudioModalOpen(true)}
                                                    className="w-full text-left px-4 py-3 hover:bg-purple-50 rounded-b-xl text-sm font-bold text-purple-600 block flex items-center gap-2"
                                                >
                                                    üéß Podcast Synthesis
                                                </button>
                                            </>
                                        )}
                                    </div>
                                </div>

                                <button
                                    onClick={() => document.body.classList.toggle('font-dyslexic')}
                                    className="px-3 py-2 bg-white border border-gray-200 text-slate-600 rounded-lg hover:bg-gray-50 font-bold"
                                    title="Toggle Dyslexic Font"
                                >
                                    Aa
                                </button>
                                <div className="flex items-center gap-2 px-3 py-1 bg-gray-50 rounded-lg border border-gray-100 mr-2">
                                    <div className={`w-2 h-2 rounded-full ${saveStatus === 'saved' ? 'bg-green-500' : (saveStatus === 'saving' ? 'bg-yellow-500 animate-pulse' : 'bg-gray-300')}`}></div>
                                    <span className="text-xs font-medium text-slate-500 capitalize">{saveStatus}</span>
                                </div>
                                <button
                                    onClick={handleExportPDF}
                                    className="px-4 py-2 bg-slate-900 text-white rounded-lg font-medium hover:bg-slate-800 transition shadow-lg text-sm"
                                >
                                    üìÑ Report PDF
                                </button>
                                {(USER_TIER === 'professor' || USER_TIER === 'pro') && (
                                    <button
                                        onClick={openExportModal}
                                        className="px-4 py-2 bg-orange-600 text-white rounded-lg font-medium hover:bg-orange-700 transition shadow-lg flex items-center gap-2"
                                    >
                                        <span>üìä</span> Export PPT
                                    </button>
                                )}
                            </div>
                        </header>

                        <div className="flex-1 bg-gray-50 overflow-auto p-8 flex flex-col items-center">

                            {/* Onboarding Banner */}
                            {/* Onboarding Banner */}
                            {!localStorage.getItem('hasSeenWorkspaceTour') && (
                                <div id="workspaceTourContainer" className="w-full max-w-4xl bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-4 rounded-xl shadow-lg mb-6 flex justify-between items-center animate-fade-in-down">
                                    <div className="flex gap-3 items-center">
                                        <div className="bg-white/20 p-2 rounded-lg text-xl">üí°</div>
                                        <div>
                                            <h4 className="font-bold">Pro Tip:</h4>
                                            <p className="text-sm opacity-90">Use <span className="font-bold bg-white/20 px-1 rounded">‚ú® AI Polish</span> to rewrite your notes, and <span className="font-bold bg-white/20 px-1 rounded">üì∑ Add Media</span> to insert images for your slides.</p>
                                        </div>
                                    </div>
                                    <button
                                        onClick={() => {
                                            localStorage.setItem('hasSeenWorkspaceTour', 'true');
                                            const el = document.getElementById('workspaceTourContainer');
                                            if (el) el.style.display = 'none';
                                        }}
                                        className="text-white/80 hover:text-white hover:bg-white/10 p-2 rounded-full transition"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" /></svg>
                                    </button>
                                </div>
                            )}

                            <div className="w-full max-w-7xl mb-6 flex gap-4">
                                <button
                                    onClick={() => setActiveTab('editor')}
                                    className={`px-6 py-2 rounded-xl font-bold transition flex items-center gap-2 ${activeTab === 'editor' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-50'}`}
                                >
                                    <i className="fas fa-file-alt"></i> Notes & Summary
                                </button>
                                <button
                                    onClick={() => setActiveTab('whiteboard')}
                                    className={`px-6 py-2 rounded-xl font-bold transition flex items-center gap-2 ${activeTab === 'whiteboard' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-50'}`}
                                >
                                    <i className="fas fa-chalkboard"></i> Visual Whiteboard
                                </button>
                            </div>

                            <div className="w-full max-w-7xl bg-white shadow-xl rounded-xl min-h-[900px] h-fit border border-gray-100 mb-20 overflow-hidden">
                                {activeTab === 'editor' ? (
                                    <>
                                        <div className="border-b p-2 flex gap-4 items-center bg-slate-50 text-gray-500 text-sm overflow-x-auto">
                                            <div className="flex bg-white rounded-lg border p-1 gap-1">
                                                <button onClick={() => editor.chain().focus().toggleBold().run()} aria-label="Bold" className={`p-1.5 px-3 rounded hover:bg-gray-100 ${editor?.isActive('bold') ? 'bg-indigo-50 text-indigo-600 font-bold' : ''}`}>B</button>
                                                <button onClick={() => editor.chain().focus().toggleItalic().run()} aria-label="Italic" className={`p-1.5 px-3 rounded hover:bg-gray-100 ${editor?.isActive('italic') ? 'bg-indigo-50 text-indigo-600 font-bold' : ''}`}>I</button>
                                                <button onClick={() => editor.chain().focus().toggleStrike().run()} aria-label="Strikethrough" className={`p-1.5 px-3 rounded hover:bg-gray-100 ${editor?.isActive('strike') ? 'bg-indigo-50 text-indigo-600 font-bold' : ''}`}>S</button>
                                            </div>
                                            <div className="flex bg-white rounded-lg border p-1 gap-1">
                                                <button onClick={() => editor.chain().focus().toggleHeading({ level: 1 }).run()} aria-label="Heading 1" className={`p-1.5 px-3 rounded hover:bg-gray-100 ${editor?.isActive('heading', { level: 1 }) ? 'bg-indigo-50 text-indigo-600 font-bold' : ''}`}>H1</button>
                                                <button onClick={() => editor.chain().focus().toggleHeading({ level: 2 }).run()} aria-label="Heading 2" className={`p-1.5 px-3 rounded hover:bg-gray-100 ${editor?.isActive('heading', { level: 2 }) ? 'bg-indigo-50 text-indigo-600 font-bold' : ''}`}>H2</button>
                                            </div>
                                            <div className="flex bg-white rounded-lg border p-1 gap-1">
                                                <button onClick={() => editor.chain().focus().toggleBulletList().run()} aria-label="Bullet List" className={`p-1.5 px-3 rounded hover:bg-gray-100 ${editor?.isActive('bulletList') ? 'bg-indigo-50 text-indigo-600 font-bold' : ''}`}><i className="fas fa-list-ul"></i></button>
                                                <button onClick={() => editor.chain().focus().toggleOrderedList().run()} aria-label="Ordered List" className={`p-1.5 px-3 rounded hover:bg-gray-100 ${editor?.isActive('orderedList') ? 'bg-indigo-50 text-indigo-600 font-bold' : ''}`}><i className="fas fa-list-ol"></i></button>
                                            </div>
                                            <button onClick={() => editor.chain().focus().toggleBlockquote().run()} aria-label="Blockquote" className={`p-1.5 px-3 bg-white border rounded hover:bg-gray-100 ${editor?.isActive('blockquote') ? 'bg-indigo-50 text-indigo-600 font-bold' : ''}`}><i className="fas fa-quote-right"></i></button>
                                        </div>
                                        <div ref={editorRef} />
                                    </>
                                ) : (
                                    <Whiteboard />
                                )}
                            </div>
                        </div>

                        {isExportModalOpen && (
                            <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                                <div ref={exportModalRef} className="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[85vh] overflow-y-auto animate-fade-in-up flex flex-col">
                                    <div className="p-6 border-b border-gray-100 flex-shrink-0 bg-white sticky top-0 z-10 flex justify-between items-center">
                                        <div>
                                            <h3 className="text-xl font-bold text-slate-900">Export Presentation</h3>
                                            <p className="text-sm text-slate-500 mt-1">Select format and style.</p>
                                        </div>
                                        <button onClick={() => setIsExportModalOpen(false)} aria-label="Close" className="text-slate-400 hover:text-slate-600 p-2">
                                            <i className="fas fa-times text-xl"></i>
                                        </button>
                                    </div>

                                    <div className="p-6 space-y-6">
                                        {/* Remove File Type Selection - We will show both buttons */}

                                        {/* Style Selection */}
                                        <div>
                                            <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">AI Writing Style</label>
                                            <div className="grid grid-cols-4 gap-2">
                                                {styles.map(style => (
                                                    <button
                                                        key={style.id}
                                                        onClick={() => setSelectedStyle(style.id)}
                                                        className={`p-2 rounded-lg border text-center transition ${selectedStyle === style.id ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-gray-200 hover:bg-gray-50'}`}
                                                    >
                                                        <div className="text-xl mb-1">{style.icon}</div>
                                                        <div className="text-[10px] font-bold">{style.name}</div>
                                                    </button>
                                                ))}
                                            </div>
                                        </div>

                                        {/* Slide Count Selection */}
                                        <div>
                                            <div className="flex justify-between items-center mb-2">
                                                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider block">Slide Count</label>
                                                <span className="text-sm font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-md">{slideCount} Slides</span>
                                            </div>
                                            <input
                                                type="range"
                                                min="1"
                                                max="20"
                                                value={slideCount}
                                                onChange={(e) => setSlideCount(parseInt(e.target.value))}
                                                className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                                            />
                                            <div className="flex justify-between text-[10px] text-gray-400 mt-1">
                                                <span>1</span>
                                                <span>10</span>
                                                <span>20</span>
                                            </div>
                                        </div>

                                        {/* Format Selection */}
                                        <div>
                                            <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">Format</label>
                                            <div className="grid grid-cols-2 gap-3">
                                                <button
                                                    onClick={() => setSelectedFormat('16:9')}
                                                    className={`p-3 rounded-lg border-2 flex flex-col items-center gap-2 transition ${selectedFormat === '16:9' ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-gray-200 hover:border-blue-200 text-slate-600'}`}
                                                >
                                                    <div className="w-12 h-8 border-2 border-current rounded-sm"></div>
                                                    <span className="text-xs font-bold">Standard (16:9)</span>
                                                </button>
                                                <button
                                                    onClick={() => setSelectedFormat('1:1')}
                                                    className={`p-3 rounded-lg border-2 flex flex-col items-center gap-2 transition ${selectedFormat === '1:1' ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-gray-200 hover:border-blue-200 text-slate-600'}`}
                                                >
                                                    <div className="w-8 h-8 border-2 border-current rounded-sm"></div>
                                                    <span className="text-xs font-bold">Carousel (1:1)</span>
                                                </button>
                                            </div>
                                        </div>

                                        {/* Theme Selection */}
                                        <div>
                                            <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">Theme</label>
                                            <div className="grid grid-cols-2 gap-3">
                                                {themes.map(theme => (
                                                    <button
                                                        key={theme.id}
                                                        onClick={() => setSelectedTheme(theme.id)}
                                                        className={`p-3 rounded-lg border-2 text-left transition relative ${theme.color} ${selectedTheme === theme.id ? 'ring-2 ring-blue-500 ring-offset-2 border-transparent' : 'border-gray-200 hover:border-blue-300'}`}
                                                    >
                                                        <div className="font-bold text-sm">{theme.name}</div>
                                                        {selectedTheme === theme.id && <div className="absolute top-2 right-2 text-blue-500"><i className="fas fa-check-circle text-xs"></i></div>}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex flex-col gap-3 p-4 border-t border-gray-100 bg-gray-50 rounded-b-2xl">
                                        <div className="flex gap-2">
                                            <button
                                                onClick={handlePreviewPDF}
                                                disabled={isGenerating}
                                                className="flex-1 py-3 bg-white border border-blue-200 text-blue-700 font-bold rounded-xl hover:bg-blue-50 transition shadow-sm flex items-center justify-center gap-2"
                                            >
                                                {isGenerating ? 'Wait...' : 'üëÅÔ∏è Preview PDF'}
                                            </button>

                                            <button
                                                onClick={() => confirmExportPPT('pdf')}
                                                disabled={isGenerating}
                                                className="flex-1 py-3 bg-red-100 text-red-700 font-bold rounded-xl hover:bg-red-200 transition shadow-sm flex items-center justify-center gap-2"
                                            >
                                                {isGenerating ? 'Wait...' : 'üì• PDF Slides'}
                                            </button>
                                        </div>

                                        <button
                                            onClick={() => confirmExportPPT('pptx')}
                                            disabled={isGenerating}
                                            className="w-full py-3 bg-gradient-to-r from-orange-500 to-red-600 text-white font-bold rounded-xl hover:shadow-lg hover:scale-[1.01] transition shadow-orange-200"
                                        >
                                            {isGenerating ? (
                                                <span className="animate-pulse">Generating Presentation... (takes ~20s)</span>
                                            ) : (
                                                <span className="flex items-center justify-center gap-2">
                                                    <span>üìä</span> Download PowerPoint (.pptx)
                                                </span>
                                            )}
                                        </button>

                                        <button
                                            onClick={() => setIsExportModalOpen(false)}
                                            className="w-full text-center text-slate-400 text-sm hover:text-slate-600"
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )
                        }

                        {/* Loading Overlay */}
                        {
                            isStudyLoading && (
                                <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
                                    <div className="bg-white p-6 rounded-2xl shadow-xl flex items-center gap-4 animate-bounce">
                                        <span className="text-2xl">üß†</span>
                                        <span className="font-bold text-slate-800">AI is studying your notes...</span>
                                    </div>
                                </div>
                            )
                        }

                        {/* Quiz Modal */}
                        {
                            isQuizModalOpen && (
                                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                                    <div ref={quizModalRef} className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[85vh] overflow-y-auto animate-fade-in-up flex flex-col">
                                        <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-10">
                                            <h3 className="text-xl font-bold text-slate-900">üìù Practice Quiz</h3>
                                            <button onClick={() => setIsQuizModalOpen(false)} aria-label="Close" className="text-slate-400 hover:text-slate-600"><i className="fas fa-times"></i></button>
                                        </div>
                                        <div className="p-8 space-y-8">
                                            {quizScore === null ? (
                                                quizData.map((q, qImg) => (
                                                    <div key={qImg} className="space-y-3">
                                                        <p className="font-bold text-lg text-slate-800">{qImg + 1}. {q.question}</p>
                                                        <div className="grid grid-cols-1 gap-2">
                                                            {q.options.map((opt, oIdx) => (
                                                                <button
                                                                    key={oIdx}
                                                                    onClick={() => setQuizAnswers({ ...quizAnswers, [qImg]: opt })}
                                                                    className={`p-3 text-left rounded-lg border transition ${quizAnswers[qImg] === opt ? 'border-purple-500 bg-purple-50 text-purple-700' : 'border-gray-200 hover:bg-gray-50'}`}
                                                                >
                                                                    {opt}
                                                                </button>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))
                                            ) : (
                                                <div className="text-center py-10">
                                                    <div className="text-6xl mb-4">üèÜ</div>
                                                    <h2 className="text-3xl font-bold text-slate-800 mb-2">You Scored {quizScore} / {quizData.length}</h2>
                                                    <p className="text-slate-500">Keep practicing to master your notes!</p>
                                                    <button onClick={() => { setQuizScore(null); setQuizAnswers({}); }} className="mt-6 px-6 py-2 bg-gray-100 text-slate-700 font-bold rounded-lg hover:bg-gray-200">Try Again</button>
                                                </div>
                                            )}
                                        </div>
                                        {quizScore === null && (
                                            <div className="p-6 border-t border-gray-100 bg-gray-50 flex justify-end">
                                                <button
                                                    onClick={submitQuiz}
                                                    className="px-6 py-3 bg-purple-600 text-white font-bold rounded-xl hover:bg-purple-700 transition shadow-lg"
                                                >
                                                    Submit Answers
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )
                        }

                        {/* Flashcard Modal */}
                        {
                            isFlashcardModalOpen && flashcardData.length > 0 && (
                                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                                    <div ref={flashcardModalRef} className="w-full max-w-xl relative">
                                        <div className="flex justify-between items-center mb-4 text-white">
                                            <h3 className="text-xl font-bold">Flashcards ({currentCardIndex + 1}/{flashcardData.length})</h3>
                                            <div className="flex gap-4">
                                                <button
                                                    onClick={() => {
                                                        const content = flashcardData.map(c => `Q: ${c.front}\nA: ${c.back}`).join('\n\n---\n\n');
                                                        const blob = new Blob([content], { type: 'text/plain' });
                                                        const url = URL.createObjectURL(blob);
                                                        const a = document.createElement('a');
                                                        a.href = url;
                                                        a.download = 'flashcards.txt';
                                                        a.click();
                                                    }}
                                                    className="text-white/70 hover:text-white flex items-center gap-1"
                                                    title="Download as Text"
                                                >
                                                    <i className="fas fa-file-alt"></i> Text
                                                </button>
                                                <button
                                                    onClick={() => {
                                                        const csvContent = flashcardData.map(c => {
                                                            const f = c.front.replace(/"/g, '""');
                                                            const b = c.back.replace(/"/g, '""');
                                                            return `"${f}","${b}"`;
                                                        }).join('\n');

                                                        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                                                        const url = URL.createObjectURL(blob);
                                                        const a = document.createElement('a');
                                                        a.href = url;
                                                        a.download = 'anki_import.csv';
                                                        a.click();
                                                    }}
                                                    className="text-blue-200 hover:text-white flex items-center gap-1 font-bold"
                                                    title="Export for Anki"
                                                >
                                                    <i className="fas fa-download"></i> Anki (CSV)
                                                </button>
                                                <button onClick={() => setIsFlashcardModalOpen(false)} className="text-white/70 hover:text-white">
                                                    <i className="fas fa-times text-2xl"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <div className="relative h-80 w-full perspective-1000 cursor-pointer group mb-12" onClick={() => setIsFlipped(!isFlipped)}>
                                            <div className={`relative w-full h-full text-center transition-transform duration-500 transform-style-3d ${isFlipped ? 'rotate-y-180' : ''}`}>
                                                {/* Front */}
                                                <div className="absolute inset-0 w-full h-full bg-white rounded-2xl shadow-2xl flex flex-col items-center justify-center p-8 backface-hidden relative">
                                                    <button
                                                        onClick={(e) => { e.stopPropagation(); setIsFlashcardModalOpen(false); }}
                                                        className="absolute top-4 right-4 text-gray-300 hover:text-gray-500"
                                                    >
                                                        <i className="fas fa-times"></i>
                                                    </button>
                                                    <span className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">Term</span>
                                                    <h2 className="text-3xl font-bold text-slate-900 font-handwriting">{flashcardData[currentCardIndex].front}</h2>
                                                    <p className="absolute bottom-6 text-xs text-slate-400">Click to flip ‚Üª</p>
                                                </div>
                                                {/* Back */}
                                                <div className="absolute inset-0 w-full h-full bg-gradient-to-br from-purple-600 to-indigo-600 text-white rounded-2xl shadow-2xl flex flex-col items-center justify-center p-8 backface-hidden rotate-y-180 relative">
                                                    <button
                                                        onClick={(e) => { e.stopPropagation(); setIsFlashcardModalOpen(false); }}
                                                        className="absolute top-4 right-4 text-white/50 hover:text-white"
                                                    >
                                                        <i className="fas fa-times"></i>
                                                    </button>
                                                    <span className="text-sm font-bold text-white/60 uppercase tracking-widest mb-4">Definition</span>
                                                    <p className="text-xl font-medium leading-relaxed font-handwriting">{flashcardData[currentCardIndex].back}</p>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="flex justify-center gap-4 mt-8">
                                            <button
                                                onClick={() => {
                                                    setIsFlipped(false);
                                                    setCurrentCardIndex(Math.max(0, currentCardIndex - 1));
                                                }}
                                                disabled={currentCardIndex === 0}
                                                className="px-6 py-3 bg-white/10 hover:bg-white/20 text-white rounded-xl font-bold backdrop-blur-md transition disabled:opacity-50"
                                            >
                                                ‚Üê Previous
                                            </button>
                                            <button
                                                onClick={() => {
                                                    setIsFlipped(false);
                                                    setCurrentCardIndex(Math.min(flashcardData.length - 1, currentCardIndex + 1));
                                                }}
                                                disabled={currentCardIndex === flashcardData.length - 1}
                                                className="px-6 py-3 bg-white text-purple-900 rounded-xl font-bold shadow-lg hover:bg-gray-100 transition"
                                            >
                                                Next Card ‚Üí
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )
                        }

                        {/* Social Clips Modal */}
                        {isClipsModalOpen && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                                <div ref={clipsModalRef} className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[85vh] overflow-y-auto animate-fade-in-up flex flex-col">
                                    <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-10">
                                        <h3 className="text-xl font-bold text-slate-900 flex items-center gap-2">üé¨ Social Clips Intelligence <span className="bg-pink-100 text-pink-600 text-xs px-2 py-1 rounded-full">Pro</span></h3>
                                        <button onClick={() => setIsClipsModalOpen(false)} aria-label="Close" className="text-slate-400 hover:text-slate-600"><i className="fas fa-times"></i></button>
                                    </div>

                                    <div className="p-8">
                                        {clipsData.length === 0 ? (
                                            <div className="text-center space-y-4">
                                                <div className="p-4 bg-blue-50 text-blue-800 rounded-lg text-sm mb-6">
                                                    üí° <strong>Tip:</strong> Paste the original YouTube URL to find viral moments based on audio timestamps.
                                                </div>
                                                <input
                                                    type="text"
                                                    placeholder="Paste YouTube URL here..."
                                                    className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 outline-none"
                                                    value={clipsUrl}
                                                    onChange={(e) => setClipsUrl(e.target.value)}
                                                />
                                                <button
                                                    onClick={async () => {
                                                        if (!clipsUrl) return alert("Please enter a URL");
                                                        setIsStudyLoading(true);
                                                        try {
                                                            const res = await fetch('/editor/generate-clips', {
                                                                method: 'POST',
                                                                headers: { 'Content-Type': 'application/json' },
                                                                body: JSON.stringify({ video_url: clipsUrl })
                                                            });
                                                            const data = await res.json();
                                                            if (data.clips) setClipsData(data.clips);
                                                            else alert("No clips found or error.");
                                                        } catch (e) {
                                                            alert("Error: " + e);
                                                        } finally {
                                                            setIsStudyLoading(false);
                                                        }
                                                    }}
                                                    className="px-8 py-3 bg-pink-600 text-white font-bold rounded-xl hover:bg-pink-700 transition shadow-lg w-full flex justify-center items-center gap-2"
                                                >
                                                    {isStudyLoading ? 'Analyzing Viral Potential...' : '‚ú® Find Viral Clips'}
                                                </button>
                                            </div>
                                        ) : (
                                            <div className="space-y-6">
                                                <div className="flex justify-between items-center">
                                                    <h4 className="font-bold text-gray-500 uppercase tracking-wider text-xs">Identified {clipsData.length} Viral Candidates</h4>
                                                    <button onClick={() => setClipsData([])} className="text-sm text-blue-600 hover:underline">Analyze Another Video</button>
                                                </div>

                                                {clipsData.map((clip, idx) => (
                                                    <div key={idx} className="border border-gray-200 rounded-xl p-4 hover:shadow-md transition bg-white group">
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div className="flex items-center gap-2">
                                                                <span className="bg-green-100 text-green-700 font-bold px-2 py-1 rounded text-xs">Viral Score: {clip.viral_score}</span>
                                                                <span className="text-slate-400 text-xs">Cannot download (Mock)</span>
                                                            </div>
                                                            <a
                                                                href={clipsUrl.includes('?') ? (clipsUrl + '&t=' + Math.floor(clip.start_time) + 's') : (clipsUrl + '?t=' + Math.floor(clip.start_time) + 's')}
                                                                target="_blank"
                                                                className="text-pink-600 font-bold text-sm hover:underline flex items-center gap-1"
                                                            >
                                                                ‚ñ∂ Play Segment
                                                            </a>
                                                        </div>
                                                        <h5 className="font-bold text-slate-800 mb-1">"{clip.suggested_caption}"</h5>
                                                        <p className="text-sm text-slate-500 mb-3">{clip.reason}</p>
                                                        <div className="bg-gray-50 p-2 rounded text-xs font-mono text-gray-600 flex justify-between">
                                                            <span>Start: {Math.floor(clip.start_time)}s</span>
                                                            <span>End: {Math.floor(clip.end_time)}s</span>
                                                            <span>Duration: {Math.floor(clip.end_time - clip.start_time)}s</span>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                        {/* Carousel Modal */}
                        {isCarouselModalOpen && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                                <div ref={carouselModalRef} className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden animate-fade-in-up">
                                    <div className="p-6 border-b flex justify-between items-center bg-slate-50">
                                        <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">üé° Social Carousel Script</h2>
                                        <button onClick={() => setIsCarouselModalOpen(false)} className="text-slate-400 hover:text-slate-600">
                                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                        </button>
                                    </div>
                                    <div className="flex-1 overflow-y-auto p-8 prose prose-slate">
                                        <div className="whitespace-pre-wrap font-sans text-slate-700 leading-relaxed">
                                            {carouselData}
                                        </div>
                                    </div>
                                    <div className="p-6 border-t bg-white flex justify-end gap-3">
                                        <button
                                            onClick={() => {
                                                navigator.clipboard.writeText(carouselData);
                                                alert("Copied to clipboard!");
                                            }}
                                            className="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition"
                                        >
                                            Copy Script
                                        </button>
                                        <button
                                            onClick={() => setIsCarouselModalOpen(false)}
                                            className="px-6 py-2 bg-slate-100 text-slate-600 rounded-lg font-bold hover:bg-slate-200 transition"
                                        >
                                            Close
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                        {/* Audio Overview Modal */}
                        {isAudioModalOpen && (
                            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden animate-fade-in-up">
                                    <div className="p-6 border-b flex justify-between items-center bg-slate-50">
                                        <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">üéß Audio Overview (Podcast)</h2>
                                        <button onClick={() => setIsAudioModalOpen(false)} className="text-slate-400 hover:text-slate-600">
                                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
                                        </button>
                                    </div>

                                    <div className="flex-1 overflow-y-auto p-6 space-y-4 bg-slate-50">
                                        {audioScript.length === 0 ? (
                                            <div className="text-center py-10">
                                                <div className="text-6xl mb-4">üéôÔ∏è</div>
                                                <p className="text-slate-600 mb-6">Turn your notes into an engaging podcast dialogue between two AI hosts.</p>
                                                <button
                                                    onClick={handleGenerateAudioScript}
                                                    disabled={isAudioLoading}
                                                    className="px-6 py-3 bg-indigo-600 text-white rounded-full font-bold hover:bg-indigo-700 transition disabled:opacity-50 flex items-center gap-2 mx-auto"
                                                >
                                                    {isAudioLoading ? 'Generating Script...' : '‚ú® Generate Podcast Script'}
                                                </button>
                                            </div>
                                        ) : (
                                            <div className="space-y-4">
                                                {audioScript.map((line, idx) => (
                                                    <div key={idx} className={`flex gap-4 ${line.speaker.includes("Alex") ? "flex-row" : "flex-row-reverse"}`}>
                                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white font-bold shrink-0 ${line.speaker.includes("Alex") ? "bg-blue-500" : "bg-purple-500"}`}>
                                                            {line.speaker[0]}
                                                        </div>
                                                        <div className={`p-4 rounded-2xl max-w-[80%] ${line.speaker.includes("Alex") ? "bg-white rounded-tl-none shadow-sm" : "bg-purple-50 rounded-tr-none text-purple-900"}`}>
                                                            <div className="text-xs font-bold opacity-50 mb-1">{line.speaker}</div>
                                                            {line.text}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>

                                    <div className="p-6 border-t bg-white">
                                        {audioUrl ? (
                                            <div className="space-y-2">
                                                <audio controls src={audioUrl} className="w-full" autoPlay />
                                                <a href={audioUrl} download="podcast.mp3" className="block text-center text-sm text-blue-600 hover:underline">Download MP3</a>
                                            </div>
                                        ) : (
                                            audioScript.length > 0 && (
                                                <button
                                                    onClick={handleSynthesizeAudio}
                                                    disabled={isAudioLoading}
                                                    className="w-full py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition disabled:opacity-50 flex items-center justify-center gap-2"
                                                >
                                                    {isAudioLoading ? (
                                                        <><svg className="animate-spin h-5 w-5 text-white" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"></circle></svg> Synthesizing Audio...</>
                                                    ) : (
                                                        '‚ñ∂Ô∏è Play Audio Overview'
                                                    )}
                                                </button>
                                            )
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                        {/* Chat Assistant Sidebar (Floating or Fixed) */}
                        <div className={`fixed right-0 top-16 bottom-0 w-80 bg-white shadow-2xl border-l transform transition-transform duration-300 z-40 flex flex-col ${isChatOpen ? 'translate-x-0' : 'translate-x-full'}`}>
                            <div className="p-4 border-b bg-indigo-50 flex justify-between items-center">
                                <h3 className="font-bold text-indigo-900 flex items-center gap-2">ü§ñ Video Assistant</h3>
                                <button onClick={() => setIsChatOpen(false)} className="text-indigo-400 hover:text-indigo-700">
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" /></svg>
                                </button>
                            </div>

                            <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50">
                                {chatHistory.map((msg, idx) => (
                                    <div key={idx} className={`p-3 rounded-lg text-sm ${msg.role === 'user' ? 'bg-indigo-600 text-white ml-8 rounded-tr-none' : 'bg-white border mr-8 rounded-tl-none text-slate-700'}`}>
                                        {msg.text}
                                    </div>
                                ))}
                                {isChatLoading && (
                                    <div className="flex gap-2 p-2">
                                        <div className="w-2 h-2 bg-indigo-400 rounded-full animate-bounce"></div>
                                        <div className="w-2 h-2 bg-indigo-400 rounded-full animate-bounce delay-100"></div>
                                        <div className="w-2 h-2 bg-indigo-400 rounded-full animate-bounce delay-200"></div>
                                    </div>
                                )}
                            </div>

                            <form onSubmit={handleChatSubmit} className="p-3 border-t bg-white">
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={chatInput}
                                        onChange={(e) => setChatInput(e.target.value)}
                                        placeholder="Ask about the video..."
                                        className="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500"
                                        disabled={isChatLoading}
                                    />
                                    <button
                                        type="submit"
                                        disabled={isChatLoading || !chatInput.trim()}
                                        className="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition disabled:opacity-50"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                                    </button>
                                </div>
                            </form>
                        </div>

                        {/* Floating Chat Toggle Button */}
                        {!isChatOpen && (
                            <button
                                onClick={() => setIsChatOpen(true)}
                                className="fixed bottom-6 right-6 p-4 bg-indigo-600 text-white rounded-full shadow-2xl hover:bg-indigo-700 transition z-50 animate-bounce-slow"
                            >
                                <span className="text-2xl">ü§ñ</span>
                            </button>
                        )}
                    </main >
                </div >
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<DocumentEditor />);
    </script>
</body>

</html>